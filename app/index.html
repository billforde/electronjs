<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Active Report Viewer</title>
    <link rel="stylesheet" href="jquery/jquery_ui_ar_min.css">
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">
    <link href="Office-Ribbon/ribbon/ribbon.css" rel="stylesheet" type="text/css" />
    <link href="Office-Ribbon/soft_button.css" rel="stylesheet" type="text/css" />
    <script src="jquery/jquery_min.js"></script>
    <script src="jquery/jquery_ui_ar_min.js"></script>
    <!--script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script-->
    <script type="text/javascript" src="Office-Ribbon/ribbon/ribbon.js"></script>
    <script type="text/javascript"></script>
</head>
<body style="width: 100%; height: 100%;">
<input style="display:none;" id="fileDialog" type="file" />
<input style="display:none;" id="saveDialog" saveas type="file" />
<!-- Dialog prompt for filename... -->
<div id="dialog-message" title="Enter Filename" style="display: none;">
    <p>
        Enter the filename to be saved into your Google Drive.
    </p>
    <input type="text" id="googleFilename"/>
</div>
<div id="dialog-listFiles" title="Select Files" style="display: none;">
    <p>
        Select the files to load from your Google Drive.
    </p>
    <div id="download-list" style="height:300px;overflow:scroll">

    </div>
</div>
<!--End Dialog prompt for filename... -->
<script type="text/javascript">
    $(document).ready(function () {
        $('#ribbon').ribbon();

        $('#enable-btn').click(function() {
            $('#del-table-btn').enable();
            $('#del-page-btn').enable();
            $('#save-btn').enable();
            $('#other-btn-2').enable();

            $('#enable-btn').hide();
            $('#disable-btn').show();
        });
        $('#disable-btn').click(function() {
            $('#del-table-btn').disable();
            $('#del-page-btn').disable();
            $('#save-btn').disable();
            $('#other-btn-2').disable();

            $('#disable-btn').hide();
            $('#enable-btn').show();
        });
        //handle click
        $('.ribbon-button').click(function() {
            if (this.isEnabled()) {
                //alert($(this).attr('id') + ' clicked');
                if ($(this).attr('id')=='open-file-button')
                    chooseFile("#fileDialog");
                if ($(this).attr('id')=='print-button')
                    printReport();
                if ($(this).attr('id')=='save-button')
                    saveFile("#saveDialog");
                if ($(this).attr('id')=='email-button')
                    emailFile();
                if ($(this).attr('id')=='saveToGoogle-button')
                    signinToGoogle('upload');
                if ($(this).attr('id')=='loadFromGoogle-button')
                    signinToGoogle('listfiles');
            }
        });
        $('#tabsContainer').tabs();
        $("#tabsContainer").tabs("option", "heightStyle", "fill");
        //handle file selection from the dialog
        $('#fileDialog').change(function(){
            //alert(this.value);
            var myNextTabId = addTabs(this.files[0].path);
            loadDocIntoTab(this.files[0].path, myNextTabId);
        });
        $('#saveDialog').change(function(){
            //alert(this.value);
            saveCurrentTab(this.files[0].path);
        });
        /***** not jquery syntax
        var chooser = document.querySelector('#fileDialog');
        chooser.addEventListener("change", function(evt) {
            alert(this.value);
            var myNextTabId = addTabs(this.value);
            loadDocIntoTab(this.value, myNextTabId);
        }, false);
         ******/
    });
    //display the file dialog
    function chooseFile(name) {
        var chooser = document.querySelector(name);
        chooser.value = "";
        chooser.click();
    }
    function saveFile(name) {
      var dialog = require('electron').remote.dialog;
      //dialog.showOpenDialog({properties: ['openFile', 'openDirectory', 'promptToCreate']});
        dialog.showOpenDialog({properties: ['promptToCreate','createDirectory','openFile'],buttonLabel:"Save"},function(filename){
            var empty=1;
            saveCurrentTab(filename[0]);
        });
    }

    //chooseFile('#fileDialog');

</script>
<!--div style="height: 202px; "-->
    <div id="ribbon">
        <span class="ribbon-window-title">Active Report Viewer</span>
        <div class="ribbon-tab" id="file-tab">
            <span class="ribbon-title">File</span>
            <div class="ribbon-section">
                <span class="section-title">Files</span>
                <div class="ribbon-button ribbon-button-large" id="open-file-button">
                    <span class="button-title">Open<br/>File</span>
                    <!--span class="button-help">This button will add a table to your document.</span-->
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/open-page.png" />
                </div>
                <div class="ribbon-button ribbon-button-large" id="save-button">
                    <span class="button-title">Save<br/>File</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/hot/save.png" width="32"/>
                </div>
                <div class="ribbon-button ribbon-button-large" id="print-button">
                    <span class="button-title">Print</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/run.png" width="32"/>
                </div>
                <div class="ribbon-button ribbon-button-large" id="email-button">
                    <span class="button-title">Email</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/hot/web_sheet.png" width="32"/>
                </div>
                <div class="ribbon-button ribbon-button-large" id="saveToGoogle-button">
                    <span class="button-title">Save To<br/>Google Drive</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/save-page.png" width="32"/>
                </div>
                <div class="ribbon-button ribbon-button-large" id="loadFromGoogle-button">
                    <span class="button-title">Load From<br/>Google Drive</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/open-page.png" width="32"/>
                </div>
            </div>


            <!--div class="ribbon-section">
                <span class="section-title">Share</span>
                <div class="ribbon-button ribbon-button-large" id="share-button">
                    <span class="button-title">Share</span>
                    <will open a dialog windown so u can pick where u want to share to...ex: fb, linkin>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/new-page.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/new-page.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/new-page.png" />
                </div>
                <div class="ribbon-button ribbon-button-large" id="add-filter-btn">
                    <span class="button-title">Add<br/>Filter</span>
                    <span class="button-help">This button will open a filter dialog.</span>
                    < Filter across reports>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/open-page.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/open-page.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/open-page.png" />
                </div>
            </div>


            <div class="ribbon-section">
                <span class="section-title">Actions</span>
                <div class="ribbon-button ribbon-button-small" id="run-btn">
                    <span class="button-title">Run</span>
                    <span class="button-help">This button will run the program.</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/run.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/run.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/run.png" />
                </div>
                <div class="ribbon-button ribbon-button-small" id="repeat-btn">
                    <span class="button-title">Repeat</span>
                    <span class="button-help">This button will repeat something.</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/repeat.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/repeat.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/repeat.png" />
                </div>
                <div class="ribbon-button ribbon-button-small disabled" id="save-btn">
                    <span class="button-title">Save</span>
                    <span class="button-help">This button will save your document.</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/save.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/save.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/save.png" />
                </div>
            </div-->

        </div>
    </div>
<!--/div-->
<!--div>
    <span id="homeI" class="fa fa-home" style="color:red;font-size:30pt;"></span>&nbsp;&nbsp;
    <span id="shareI" class="fa fa-share-alt-square" style="color:deepskyblue;font-size:30pt;"></span>&nbsp;&nbsp;
    <span id="printI" class="fa fa-print" style="color:black;font-size:30pt;"></span>&nbsp;&nbsp;
    <span id="saveI" class="fa fa-floppy-o" style="color:green;font-size:30pt;"></span>
</div-->
<div id="tabsContainer" style="height: 700px; width:98%;">
    <ul id="tabList">

    </ul>

</div>
<!--p>'Right click' to show context menu.</p-->

<SCRIPT>
<!--
    //Make sure that the Active APIs are all loaded!
    //if (ibiARLoader.jsloaded){ //when the Active APIs is loaded, call main to call the API
        var tabItemCount = 0;
        main();
    //}else{
     //   ibiARLoader.onload = main;
    //}

    /********************************/
    /* open an existing file will reload the active report */
    /* need to createHomeMenu? */
    /********************************/
    //var tabItemCount = 0;
    //var objIframe = {};
    //var aaa = {};
    //var firstTime = true;
    var currentTabActive = null;
    var app;
    //For Google Authentication code
    var readline;
    var google;
    var googleAuth;
    var SCOPES;
// 'https://www.googleapis.com/auth/drive.appdata',
//'https://www.googleapis.com/auth/drive.file'];
// If modifying these scopes, delete your previously saved credentials
// at ~/.credentials/drive-nodejs-quickstart.json
    var TOKEN_DIR;
    var TOKEN_PATH;
    var arguments;

    function main()
    {
        //console.log(nw.App.argv);

        //Adding the open event listener, ==>
        //open event will trigger this funtion to loadDocIntoTab
        //with the last parameter passed from the file system.

        fs = require('fs');
        readline = require('readline');
        google = require('googleapis').google;
        googleAuth = require('google-auth-library');
        SCOPES = ['https://www.googleapis.com/auth/drive'];
        // 'https://www.googleapis.com/auth/drive.appdata',
        //'https://www.googleapis.com/auth/drive.file'];
// If modifying these scopes, delete your previously saved credentials
// at ~/.credentials/drive-nodejs-quickstart.json
       // var TOKEN_DIR = (process.env.HOME || process.env.HOMEPATH ||
           // process.env.USERPROFILE) + '/.credentials/';
        TOKEN_DIR = './credentials/'
        TOKEN_PATH = TOKEN_DIR + 'drive-nodejs-quickstart.json';
        app = require('electron').remote.app; //require the library called 'electron'

        app.on('open', function(filename){
            var parm = filename.split(' ');
            var lastparm = parm[parm.length-1];  //filename
            //alert("Opening "+ lastparm);
            var lp = lastparm.split('"');
            if(lp.length>1)
                    lastparm = lp[1];
            var myNextTabId = addTabs(lastparm);
            console.log("main 1: before loadDocIntoTab tabItemCount is:" + tabItemCount);
            loadDocIntoTab(lastparm, myNextTabId);
        });

        var remote = require('electron').remote;
        var origArgs = remote.getGlobal('sharedObject').prop1;
        //remove all the options
        args = [];
        for (var i=0; i<origArgs.length; i++)
            if (origArgs[i].substr(0,2)!= "--" && //ignore option
                    origArgs[i]!= "./app" ) //ignore root app directory
                args[args.length] = origArgs[i];

        console.log(args);

        //if argument exist on command line && ...
        if (args.length > 1 && args[1] != '.') {
            $(document).ready(function () {
                console.log("main 2: before loadDocIntoTab tabItemCount is:" + tabItemCount);
               // var filename = process.argv[0];
                var filename = args[1];
                var lp = filename.split('"');
                if (lp.length > 1)
                    filename = lp[1];
                var myNextTabId = addTabs(filename);
                loadDocIntoTab(filename, myNextTabId);
            });
        }

        //createHomeMenu();
    }
    /**********************************************************************************/
    /* Load the active report using html page or json object passed from the cmd line */
    /**********************************************************************************/

    function loadDocIntoTab(filename, tabId, data)
    {
        var fs =  require('fs'); //load the node js file system library

        //read the content of hold.htm or hold.txt and close it...
        //holdfileString is the string converted from hold.txt or from hold.htm?

        var holdfileString;
        if (filename == null)
            holdfileString = JSON.stringify(data);//response.data from openGoogleFile
        else
            holdfileString = fs.readFileSync(filename).toString();

        //var holdfileString = fs.readFileSync('./hold.txt').toString();

        //at the time being, don't call the Json parser
        //Converted to Json object but error bc ==>Actually, Json parser generates mixed quotes
        //var holdfileJsonObj = JSON.parse(holdfileString);

        //var arObj = new activeReport();
        //var reportContainer =  document.getElementById('reportContainer');
        var tabItem = document.getElementById(tabId);
        tabItem.innerHTML = "";
        var htmltxt;
        var isHtmlPage = false;

        if (holdfileString.substr(0,9)== '<!DOCTYPE') { //if we have an html page ==> create the iframe
            htmltxt = new Buffer(holdfileString).toString('base64'); //64 encoded
            htmltxt = "data:text/html;base64," + htmltxt;
            isHtmlPage = true;
        } else { //if Json object(hold.txt) ==> put it into the report One div
            //htmltxt = "iFrameContent.html";
            //var iFrameContent = fs.readFileSync('iFrameContent.html').toString();
            //htmltxt must be a fully formed html doc for webview
            //htmltxt = iFrameContent.replace(/abcdefghij/i, holdfileString);
            //var newArray = iFrameContent.split("abcdefghij");
           //htmltxt = newArray[0] + holdfileString + newArray[1];

            //fs.writeFileSync("C:\\Users\\pl04334\\Documents\\abc", htmltxt, 'utf8');
            //htmltxt = new Buffer(htmltxt).toString('base64');
            //htmltxt = "data:text/html;base64," + htmltxt;

            //holdfileString is the string version of the json object
            htmltxt = "loadActiveReport("+holdfileString+")";
            /**************
            //javascript eval to convert the string to js object
            eval("var holdfileObj="+holdfileString);

            //using the Active Report api: rendering the active report into a div
            arObj.addJsonReport(holdfileObj, tabItem);
            ****************/
        }

        //create a container
        //var reportFrame = document.createElement('iframe');
        var reportFrame = document.createElement('webview');
        reportFrame.setAttribute('id',"w_" + tabId);
        reportFrame.setAttribute('partition','trusted');
        reportFrame.setAttribute('allownw',true);
        reportFrame.setAttribute('nwdisable',false);
        reportFrame.setAttribute('name',filename);
        //save the line below
        reportFrame.setAttribute('style','display:flex;height:100%;width:100%;');
        tabItem.appendChild(reportFrame);

        //empty the iframe to initialize
        //mine type: stream is text, processed as html, the encoding is expected as base64
        //reportFrame.src = "data:text/html;base64," + new Buffer("<html></html>").toString('base64');

        window.setTimeout(function() { //call later after the above code is processed.

            //create a property for each tabItem and store the json obj (holdfileString) to that property.
            //note: aaa is the global obj that will be referenced by iFrameContent. which is used to render
            //the active report.
            //aaa[filename] = holdfileString;

            //load the html content into the reportFrame ==>  already encoded to base64
            if (isHtmlPage) {
                reportFrame.addEventListener("did-finish-load", function(){
                    //reportFrame.openDevTools();
                });
                reportFrame.src = htmltxt;
            } else {
                reportFrame.addEventListener("did-finish-load", function(){
                    //after loading the iframe content page
                    //reportFrame.openDevTools();
                    reportFrame.executeJavaScript(htmltxt);
                });
                //reportFrame.src = "iFrameContent.html";
                var path = require('path');
                var url = require('url');
                reportFrame.src = url.format({
                    pathname: path.join(__dirname, 'iFrameContent.html'),
                    protocol: 'file:',
                    slashes: true
                });
            }
        },10);

        //firstTime = false;
        currentTabActive = tabId;
    }//loadDocIntoTab()
    /***************************************************/
    /*Print ==> print preview to send a doc to the printer */
    /***************************************************/
    function printReport(){

        var mywebview =  document.getElementById("w_"+currentTabActive);
        mywebview.setAttribute('style','display:flex;height:3000px;width:3000px;');

        //get the webwiew window
        //var webviewWin = nw.Window.get(mywebview.contentWindow);
        //var executetxt = "window.alert(\"Opening for printing\");var win=window; win.print({'autoprint':false})";

        window.setTimeout(function() {
            mywebview.print();
        },100);
        //var executetxt = "var win=window; win.print({'autoprint':false})";
        //mywebview.executeJavaScript(executetxt);

    }

    /***************************************************/
    /* Email                                           */
    /***************************************************/
    function emailFile()
    {

        var mywebview =  document.getElementById("w_"+currentTabActive);
        //Need to email the change of the report so ==> must do save first
        var executetxt = "$AR.saveJsonReport()";

        mywebview.executeJavaScript(executetxt,false,
                function(jsonObject){
                    var fs =  require('fs'); //load the node js file system library

                    nw.Shell.openExternal('mailto:?subject=test&body=report&attach="c:\\IDF-Viewer\\hold.adf"');
                    //need to make sure that filename ends with .adf
                    //var extension = filename.split('.');
                   // var newfilename = filename;
                    //if (extension[extension.length-1]!== 'adf')
                       // newfilename += '.adf';

                    //write the content of the json object to a file
                    //fs.writeFileSync(newfilename, JSON.stringify(jsonObject[0]));

                });

    }
    /***************************************************/
    /* Create the home menu: load an active report     */
    /***************************************************/
    function createHomeMenu(obj){
        // Create a menu
        var menu = new nw.Menu();

        // Add some items with label
        menu.append(new nw.MenuItem({
            label: 'Item A',
            click: function(){
                //alert('You have clicked at "Item A"');
            }
        }));
        menu.append(new nw.MenuItem({
                    label: 'Load Active Report',
                    click: function(){
                        var tabId = addTabs();
                        loadDocIntoTab('./hold.htm', tabId); //html
                    }
                }
        ));

        menu.append(new nw.MenuItem({ type: 'separator' }));
        menu.append(new nw.MenuItem({
                    label: 'Load Active Report APIs',
                    click: function(){
                        var tabId = addTabs();
                        loadDocIntoTab('./hold.txt', tabId); //json
                }}
        ));

        $('#homeI').on('click',function(e){
            menu.popup(e.offsetX, e.offsetY);
        });

    }
    /***************************************************/
    /***** Create the save menu: save to disk or cloud */
    /***************************************************/
    function createSaveMenu(obj){

        var menu = new nw.Menu();

        // Add some items with label
        menu.append(new nw.MenuItem({
            label: 'save to computer',
            click: function(){
                alert('You have clicked at "Save"');
            }
        }));
        menu.append(new nw.MenuItem({
            label: 'save to cloud',
            click: function(){
                alert('You have clicked at "Save"');
            }
        }));
        $('#saveI').on('click',function(e){
            menu.popup(e.offsetX, e.offsetY);
        });

    }
    /*********************************************/
    /***** Saving the content of the current tab.*/
    /*********************************************/
    function saveCurrentTab(filename){

        var mywebview =  document.getElementById("w_"+currentTabActive);
        //get the webwiew window
        //var webviewWin = nw.Window.get(mywebview.contentWindow);
        var executetxt = "$AR.saveJsonReport()";
        mywebview.executeJavaScript(executetxt,false,
                 function(jsonObject){
                     var fs =  require('fs'); //load the node js file system library

                     //need to make sure that filename ends with .adf
                     var extension = filename.split('.');
                     var newfilename = filename;
                     if (extension[extension.length-1]!== 'adf')
                         newfilename += '.adf';

                     //write the content of the json object to a file
                     fs.writeFileSync(newfilename, JSON.stringify(jsonObject));

                 });
    }

    /***************************************/
    /***** Add a new tab into the tabList. */
    /***************************************/
    function addTabs(filename){
       // if (firstTime == true) return('report1');

        var tabList = document.getElementById("tabList");
        var listItem = document.createElement('li');
        var anch = document.createElement('a');
        tabItemCount++;
        var listItemId = "report" + (tabItemCount); //id has to be unique name, not upon tabItemCount

        //set ids for listItem and for anchor ==> need id when remove listItem from tabList
        listItem.setAttribute("id", "li_"+listItemId);
        anch.setAttribute("id", "a_"+listItemId);

        //set link for the listItem
        anch.href = "#" + listItemId;
        //set label of this tab
        var shortname = filename.split('\\');
        shortname = shortname[shortname.length-1];
        //anch.innerHTML = "report " + tabItemCount + "&nbsp;&nbsp;<span onclick='closeTabs("+tabItemCount+")' style='cursor:pointer;color: red'>X</span>";
        anch.innerHTML = shortname + "&nbsp;&nbsp;<span onclick='closeTabs("+tabItemCount+")' style='cursor:pointer;color: red'>X</span>";
        anch.title = filename; //for hover over it
        listItem.appendChild(anch);
        tabList.appendChild(listItem);
        var liContent = document.createElement('div'); //create a div container to load the content of the list item
        liContent.id = listItemId;

        var tabsContainer = document.getElementById("tabsContainer");
        tabsContainer.appendChild(liContent);

        //refresh the tab list
        $("#tabsContainer").tabs("refresh");

        //make the new tab item active
        //$("#tabsContainer").tabs( "option", "active", tabItemCount-1 );
        $("#tabsContainer").tabs( "option", "active", tabList.children.length-1);
        $("#tabsContainer" ).on( "tabsactivate", function( event, ui ) {
            currentTabActive = ui.newPanel[0].id;
        } );

       // liContent.setAttribute('style', 'overflow:visible');
        return listItemId;
    }
    /***************************************/
    /***** remove this tab from the tabList. */
    /***************************************/
    function closeTabs(tabId){

        var tabList = document.getElementById("tabList");
        var listItemId = "report" + tabId;
        var listItem = document.getElementById('li_'+listItemId);
        var anch = document.getElementById('a_'+listItemId);
        var div = document.getElementById(listItemId);
        listItem.parentNode.removeChild(listItem);
        anch.parentNode.removeChild(anch);
        div.parentNode.removeChild(div);
        //refresh the tab list
        $("#tabsContainer").tabs("refresh");

    }

//-->
    function showSplashScreen(){
        var win = gui.Window.open('app.html', {
            position: 'center',
            width: 901,
            height: 127,
            frame: true
        });
    }
    /****************************************************************************************/
    /* Save to Google Drive ==> Set up the credentials, save the authentication to a token,  */
    /* which allow users to have the write access to their google drive. If we are doing an upload */
    /* then we prompt the user for a filename for storing it into the Google Drive.*/
    /* Download from Google Drive ==> users can read files from their Google Drive */
    /********************************************************************/

    function signinToGoogle(dowhat, fileId, filename) {

        // Load client secrets from a local file.
        var fullFilename = app.getAppPath()+'\\'+'client_secret.json';

        if (fs.existsSync(fullFilename))
            console.log('Checking for: '+ fullFilename);

        fs.readFile(fullFilename, function processClientSecrets(err, content) {
            if (err) {
                console.log('Error loading client secret file: ' + err);
                return;
            }
            // Authorize a client with the loaded credentials, then call the
            // Drive API.
            if (dowhat == 'upload')
                authorize(JSON.parse(content), displayUploadDialog);
            else if (dowhat == 'download')
                authorize(JSON.parse(content), openGooglefile, fileId, filename);
            else if (dowhat == 'listfiles')
                    authorize(JSON.parse(content), listFilesFromGoogle);
        });
    }
    /**
     * Create an OAuth2 client with the given credentials, and then execute the
     * given callback function.
     *
     * @param {Object} credentials The authorization client credentials.
     * @param {function} callback The callback to call with the authorized client.
     */
    function authorize(credentials, callback, fileId, filename) {
        var clientSecret = credentials.installed.client_secret;
        var clientId = credentials.installed.client_id;
        var redirectUrl = credentials.installed.redirect_uris[0];

        var oauth2Client = new googleAuth.OAuth2Client(clientId, clientSecret, redirectUrl);

        // Check if we have previously stored a token.
        fs.readFile(TOKEN_PATH, function(err, token) {
            if (err) {
                getNewToken(oauth2Client, callback);
            } else {
                oauth2Client.credentials = JSON.parse(token);
                callback(oauth2Client, fileId, filename);
            }
        });
    }

    /**
     * Get and store new token after prompting for user authorization, and then
     * execute the given callback with the authorized OAuth2 client.
     *
     * @param {google.auth.OAuth2} oauth2Client The OAuth2 client to get token for.
     * @param {getEventsCallback} callback The callback to call with the authorized
     *     client.
     */
    function getNewToken(oauth2Client, callback) {
        var authUrl = oauth2Client.generateAuthUrl({
            access_type: 'offline',
            scope: SCOPES
        });
        //let us access to the BrowserWindow object
        var BrowserWindow = require('electron').remote.BrowserWindow;

        // Or use `remote` from the renderer process.
        // const {BrowserWindow} = require('electron').remote

        var new_win = new BrowserWindow({width: 800, height: 600});
        new_win.webContents.on('dom-ready', function(e) {
            var token = e.sender.webContents.getTitle().split('=');
            if (token[0] == 'Success code') token = token[1];
            else token = null;

            if (token) {
                //alert(token.value);
                e.sender.destroy();
                oauth2Client.getToken(token, function (err, token) {
                    if (err) {
                        console.log('Error while trying to retrieve access token', err);
                        return;
                    }
                    oauth2Client.credentials = token;
                    storeToken(token);
                    callback(oauth2Client);
                });
            };
        })

        // Load a remote URL
        new_win.loadURL(authUrl);
    }

    /**
     * Store token to disk be used in later program executions.
     *
     * @param {Object} token The token to store to disk.
     */
    function storeToken(token) {
        try {
            fs.mkdirSync(TOKEN_DIR);
        } catch (err) {
            if (err.code != 'EEXIST') {
                throw err;
            }
        }
        fs.writeFile(TOKEN_PATH, JSON.stringify(token));
        console.log('Token stored to ' + TOKEN_PATH);
    }

    /**
     * Download the names and IDs of up to 10 files.
     *
     * @param {google.auth.OAuth2} auth An authorized OAuth2 client.
     * @param {fileId: id of the file that will be downloaded}.
     */

    function listFilesFromGoogle(auth, fileId) {

        var drive = google.drive({ version: 'v3', auth: auth });

        drive.files.list({

        }, function(err, response) {
            if (err) {
                console.log('The API returned an error: ' + err);
                return;
            }
            var files = response.data.files;
            if (files.length == 0) {
                console.log('No files found.');
            } else {
                console.log('Files:');
                /***
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    console.log('%s (%s)', file.name, file.id);
                }***/
                displayDownloadDialog(auth, files);
            }
        }
        );
    }

    function displayDownloadDialog(auth, files){

        var element = document.createElement('ol');
        var dl = document.getElementById('download-list')
        dl.appendChild(element);
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var li = document.createElement('li');
            li.innerHTML = "<span style='cursor:pointer' onclick='$(\"#dialog-listFiles\").dialog(\"close\");signinToGoogle(\"download\",\""+file.id+"\",\""+file.name+"\")'>"+file.name+"</span>";
            element.appendChild(li);
        }
        $( function() {
            $( "#dialog-listFiles" ).dialog({
                modal: true,
                buttons: {
                    /********
                    Ok: function() {
                        var chooser = document.querySelector("#googleFilename");
                        if (chooser.value!= "") {
                            $(this).dialog("close");
                            googleUpload(auth, chooser.value);
                        }
                    ,***********/
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        } );
    }

    function openGooglefile(auth, fileId, filename){

        var drive = google.drive({ version: 'v3', auth: auth });
        drive.files.get({
            fileId: fileId,
            alt:'media',
            mimeType:'text/plain'
        }, function(err, response) {
            if (err) {
                console.log('The API returned an error: ' + err);
                return;
            }
            var myNextTabId = addTabs(filename);
            loadDocIntoTab(null, myNextTabId, response.data);
        });
    }

    function displayUploadDialog(auth){
        $( function() {
            $( "#dialog-message" ).dialog({
                modal: true,
                buttons: {
                    Ok: function() {
                        var chooser = document.querySelector("#googleFilename");
                        if (chooser.value!= "") {
                            $(this).dialog("close");
                            googleUpload(auth, chooser.value);
                        }
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        } );
    }
    function googleUpload(auth, filename) {
        var mywebview =  document.getElementById("w_"+currentTabActive);

        var executetxt = "$AR.saveJsonReport()"; //return jsonObject

        mywebview.executeJavaScript(executetxt, false,
            function(jsonObject){
                var drive = google.drive({ version: 'v3', auth: auth });
                var fileMetadata = {
                    'name': filename,
                    'mimeType': 'application/vnd.ibi.idf'
                };
                // var holdfileString = fs.readFileSync('./hold.adf').toString();
                var media = {
                    mimeType: 'text/plain',
                    body: JSON.stringify(jsonObject)
                };
                drive.files.create({
                    //resource: fileMetadata,
                    media: media
                    //fields: 'id' need data.id
                }, function (err, file) {
                    if (err) {
                        // Handle error
                        console.error(err);
                    } else {
                        console.log('File Id:', file.data.id);
                        drive.files.update({fileId:file.data.id,
                            resource:fileMetadata})
                    }
                });
            });
    }
</script>
<!--div style="display: none">
    <iframe src="iFrameContent.html" name="dummy"/>
</div-->


</body>
</html>
