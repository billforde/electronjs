<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>In-Document Analytics Viewer</title>
    <link rel="stylesheet" href="jquery-ui-1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">
    <link href="Office-Ribbon/ribbon/ribbon.css" rel="stylesheet" type="text/css" />
    <link href="Office-Ribbon/soft_button.css" rel="stylesheet" type="text/css" />
    <script src="jquery/jquery_min.js"></script>
    <script src="jquery-ui-1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="Office-Ribbon/ribbon/ribbon.js"></script>
    <script type="text/javascript"></script>
    <script src="mime-js/src/base64.js" type="text/javascript"></script>
    <script src="mime-js/dist/mime-js.js" type="text/javascript"></script>
</head>
<body style="width: 100%; height: 100%;">
<input style="display:none;" id="loadFileDialog" type="file" />
<input style="display:none;" id="saveDialog" saveas type="file" />

<!-- Dialog prompt for filename... -->
<div id="dialog-message" title="Enter Filename" style="display: none;">
    <p>
        Enter the filename to be saved into your Google Drive.
    </p>
    <input type="text" id="googleFilename"/>
</div>

<div id="dialog-listFiles" title="Select Files" style="display: none;">
    <p>
        Select the files to load from your Google Drive.
    </p>
    <div id="download-list" style="height:300px;overflow:scroll">
    </div>
</div>

<div id="dialog-email" title="Message" style="display: none;">
    <p>
        Enter your email information below.
    </p>
    <span style="display:inline-block;width:60px">From: </span><input type="text" id="emailFrom"/><br><br>
    <span style="display:inline-block;width:60px">To: </span><input type="text" id="emailTo"/><br><br>
    <span style="display:inline-block;width:60px">Cc: </span><input type="text" id="ccTo"/><br><br>
    <span style="display:inline-block;width:60px">Subject: </span><input type="text" id="emailSubject"/><br>
</div>
<div id="dialog-gmail" title="Message" style="display: none;">
    <p>
        Enter your email information below.
    </p>
    <span style="display:inline-block;width:60px">To: </span><input type="text" id="gmailTo"/><br><br>
    <span style="display:inline-block;width:60px">CC: </span><input type="text" id="gccTo"/><br><br>
    <span style="display:inline-block;width:60px">Subject: </span><input type="text" id="gmailSubject"/><br>
</div>

<!--End Dialog prompt for filename... -->
<script type="text/javascript">
    $(document).ready(function () {

        $("#google-drive-menu").menu();
        //$(document).tooltip();
        $('#ribbon').ribbon();

        $('#enable-btn').click(function() {
            $('#del-table-btn').enable();
            $('#del-page-btn').enable();
            $('#save-btn').enable();
            $('#other-btn-2').enable();

            $('#enable-btn').hide();
            $('#disable-btn').show();
        });
        $('#disable-btn').click(function() {
            $('#del-table-btn').disable();
            $('#del-page-btn').disable();
            $('#save-btn').disable();
            $('#other-btn-2').disable();

            $('#disable-btn').hide();
            $('#enable-btn').show();
        });
        //handle click
        $('.ribbon-button').click(function() {
            if (this.isEnabled()) {
                //alert($(this).attr('id') + ' clicked');
                if ($(this).attr('id')=='open-file-button')
                    showOpenFileDialog("#loadFileDialog");
                if ($(this).attr('id')=='print-button')
                    printReport();
                if ($(this).attr('id')=='save-button')
                    showSaveDialog("#saveDialog");
                if ($(this).attr('id')=='email-button')
                    showEmailDialog("emailDialog");
                if ($(this).attr('id')=='gmail-button')
                    signinToGoogle("gmail");
            }
        });
        $('#tabsContainer').tabs();
        $("#tabsContainer").tabs("option", "heightStyle", "fill");

       } //end of callback for document.ready()
    ); //end of $(document).ready(function ()

    //open the file selector from the file system
    function showOpenFileDialog(name) {
        var dialog = require('electron').remote.dialog;
        dialog.showOpenDialog({
            filters: [
                {name: 'idfViewer files',  extensions: ["adf", "idf", "pdf"]}
            ],
            properties: ['openFile', 'multiSelections']}, function(filename){
            for (var i=0; i<filename.length; i++){
                var myNextTabId = addTabs(filename[i]);
                loadDocIntoTab(filename[i], myNextTabId);
            }
        });
        //var chooser = document.querySelector(name);
        //chooser.value = "";
        //chooser.click();
    }
    //show the system file dialog and let you enter the file name or browse the file system for saving
    function showSaveDialog(name) {
      var dialog = require('electron').remote.dialog;
      //dialog.showOpenDialog({properties: ['openFile', 'openDirectory', 'promptToCreate']});
        dialog.showSaveDialog({buttonLabel:"Save"},function(filename){
            var empty=1;
            saveCurrentTab(filename);
        });
    }

</script>
<!--div style="height: 202px; "-->
    <div id="ribbon">
        <span class="ribbon-window-title">In-Document Analytics Viewer</span>
        <div class="ribbon-tab" id="home-tab">
            <span class="ribbon-title">Home</span>
            <div class="ribbon-section">
                <!--span class="section-title">File</span-->
                <div title="Open a file from the file system" class="ribbon-button ribbon-button-large" id="open-file-button">
                    <img class="ribbon-icon ribbon-normal" src="assets/005-open-file.png" />
                </div>
                <div title="Save your document to the file system" class="ribbon-button ribbon-button-large" id="save-button">
                    <img class="ribbon-icon ribbon-normal" src="assets/001-floppy-disk-1.png" width="32"/>
                </div>
                <div title="Print" class="ribbon-button ribbon-button-large" id="print-button">
                    <img class="ribbon-icon ribbon-normal" src="assets/013-printer-1.png" width="32"/>
                </div>
                <div title="Email" class="ribbon-button ribbon-button-large" id="email-button">
                    <img class="ribbon-icon ribbon-normal" src="assets/004-envelope.png" width="32"/>
                </div>
                <div title="Merge Reports" class="ribbon-button ribbon-button-large" id="merge-button">
                    <img class="ribbon-icon ribbon-normal" src="assets/033-merge-5.png" width="32"/>
                </div>
            </div>
        </div>

        <div class="ribbon-tab" id="share-tab">
            <span class="ribbon-title">Google</span>
            <div class="ribbon-section">
                <!--span class="section-title">Share</span-->
                <div title="Gmail" class="ribbon-button ribbon-button-large" id="gmail-button">
                    <img class="ribbon-icon ribbon-normal" src="assets/002-gmail-1.png" width="32"/>
                </div>
                <div class="ribbon-button ribbon-button-large" id="google-drive-button">
                    <ul id="google-drive-menu">
                        <li>
                            <!--div-->
                            <img src="assets/011-drive.png" width="32"/>
                            <!--/div-->
                            <ul style="width:130px;text-align:left;">
                                <li><div onclick="signinToGoogle('upload');">Save to Google Drive</div></li>
                                <li><div onclick="signinToGoogle('listfiles');">Load from Google Drive</div></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!--
        <div class="ribbon-tab" id="filter-tab">
            <span class="ribbon-title">Filter</span>
            <div class="ribbon-section">
                <span class="section-title">Filter</span>
                 <div title="Filter" class="ribbon-button ribbon-button-large" id="filter-button">
                    < class="button-title">Filter</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/new-page.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/new-page.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/new-page.png" />
                </div>
            </div>
        </div>

        <!--div class="ribbon-tab" id="export-tab">
            <span class="section-title">Export</span>
            <div class="ribbon-section">
                <span class="section-title">Export>
                <div title="export" class="ribbon-button ribbon-button-large" id="export-button">
                <span class="button-title">Import/Export</span>
                <span class="button-help">This button will open a filter dialog.</span>
                    <Filter across reports>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/open-page.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/open-page.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/open-page.png" />
            </div>
          </div-->



            <!--div-- class="ribbon-section">
                <span class="section-title">Actions</span>
                <div class="ribbon-button ribbon-button-small" id="run-btn">
                    <span class="button-title">Run</span>
                    <span class="button-help">This button will run the program.</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/run.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/run.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/run.png" />
                </div>
                <div class="ribbon-button ribbon-button-small" id="repeat-btn">
                    <span class="button-title">Repeat</span>
                    <span class="button-help">This button will repeat something.</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/repeat.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/repeat.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/repeat.png" />
                </div>
                <div class="ribbon-button ribbon-button-small disabled" id="save-btn">
                    <span class="button-title">Save</span>
                    <span class="button-help">This button will save your document.</span>
                    <img class="ribbon-icon ribbon-normal" src="Office-Ribbon/icons/normal/save.png" />
                    <img class="ribbon-icon ribbon-hot" src="Office-Ribbon/icons/hot/save.png" />
                    <img class="ribbon-icon ribbon-disabled" src="Office-Ribbon/icons/disabled/save.png" />
                </div>
            </div-->

    </div>
<!--/div-->
<!--div>
    <span id="homeI" class="fa fa-home" style="color:red;font-size:30pt;"></span>&nbsp;&nbsp;
    <span id="shareI" class="fa fa-share-alt-square" style="color:deepskyblue;font-size:30pt;"></span>&nbsp;&nbsp;
    <span id="printI" class="fa fa-print" style="color:black;font-size:30pt;"></span>&nbsp;&nbsp;
    <span id="saveI" class="fa fa-floppy-o" style="color:green;font-size:30pt;"></span>
</div-->

<!-- put a tab container after the ribbon -->
<div id="tabsContainer" style="height: 700px; width:98%;">
    <ul id="tabList">
    </ul>
</div>

<SCRIPT>
<!--

    /********************************/
    /* open an existing file will reload the active report */
    /* need to createHomeMenu? */
    /********************************/
    //var firstTime = true;
    var tabItemCount = 0;
    var currentTabActive = null;
    var app;
    //For Google Authentication code
    var readline;
    var google;
    var googleAuth;
    var SCOPES;
// 'https://www.googleapis.com/auth/drive.appdata',
//'https://www.googleapis.com/auth/drive.file'];
// If modifying these scopes, delete your previously saved credentials
// at ~/.credentials/drive-nodejs-quickstart.json
    var TOKEN_DIR;
    var TOKEN_PATH;
    var arguments;

    main();

    function main()
    {
        //console.log(nw.App.argv);

        //Adding the open event listener, ==>
        //open event will trigger this funtion to loadDocIntoTab
        //with the last parameter passed from the file system.

        fs = require('fs');
        readline = require('readline');
        google = require('googleapis').google;
        googleAuth = require('google-auth-library');
        SCOPES = ['https://www.googleapis.com/auth/drive',
            'https://mail.google.com/',
            'https://www.googleapis.com/auth/gmail.modify',
            'https://www.googleapis.com/auth/gmail.compose',
            'https://www.googleapis.com/auth/gmail.send',
            'https://www.googleapis.com/auth/userinfo.profile'];
        TOKEN_DIR = './credentials/'
        TOKEN_PATH = TOKEN_DIR + 'googleService.json';
        app = require('electron').remote.app; //require the library called 'electron'

        //for -- if the app is already opened, then prevent multiple instances from the app
        var ipcRenderer = require('electron').ipcRenderer;
        ipcRenderer.send('asynchronous-message', 'ping');
        ipcRenderer.on('open-file',function(event, arg){
            var myNextTabId = addTabs(arg);
            loadDocIntoTab(arg, myNextTabId);
        });

        //this code is for nwjs -- event handling that is only happens in nwjs
        //comment out for the time being.
        /**************
        app.on('open', function(filename){
            var parm = filename.split(' ');
            var lastparm = parm[parm.length-1];  //filename
            //alert("Opening "+ lastparm);
            var lp = lastparm.split('"');
            if(lp.length>1)
                    lastparm = lp[1];
            var myNextTabId = addTabs(lastparm);
            console.log("main 1: before loadDocIntoTab tabItemCount is:" + tabItemCount);
            loadDocIntoTab(lastparm, myNextTabId);
        });
        ******************/

        var remote = require('electron').remote;
        var origArgs = remote.getGlobal('sharedObject').prop1;
        //remove all the options
        args = [];
        for (var i=0; i<origArgs.length; i++)
            if (origArgs[i].substr(0,2)!= "--" && //ignore option
                    origArgs[i]!= "./app" ) //ignore root app directory
                args[args.length] = origArgs[i];

        console.log(args);

        //if argument exist on command line && ...
        if (args.length > 1 && args[1] != '.') { //if this not a hidden file
            $(document).ready(function () {
                console.log("main 2: before loadDocIntoTab tabItemCount is:" + tabItemCount);
               // var filename = process.argv[0];
                var filename = args[1];
                var lp = filename.split('"');
                if (lp.length > 1)
                    filename = lp[1];
                var myNextTabId = addTabs(filename);
                loadDocIntoTab(filename, myNextTabId);
            });
        }
    }
    /**********************************************************************************/
    /* Load the active report using html page or json object passed from the cmd line */
    /**********************************************************************************/

    function loadDocIntoTab(filename, tabId, data)
    {
        var tabItem = document.getElementById(tabId);
        tabItem.innerHTML = "";
        var htmltxt;
        var javascriptCmd;
        var isHtmlPage = false;
        var holdfileString;
        currentTabActive = tabId;

        //create a webview as the container
        var aWebview = document.createElement('webview');
        aWebview.setAttribute('id',"w_" + tabId);
        aWebview.setAttribute('partition','trusted');
        aWebview.setAttribute('allownw',true);
        aWebview.setAttribute('plugins',true);
        aWebview.setAttribute('nwdisable',false);
        aWebview.setAttribute('name',filename);
        //save the line below
        aWebview.setAttribute('style','display:flex;height:100%;width:100%;');
        tabItem.appendChild(aWebview);

        var fs =  require('fs'); //load the node js file system library
        var filetype;
        if (filename != null){
            filetype = filename.split(".");
            filetype = filetype[filetype.length-1].toLowerCase();
        } else {
            filetype = "adf";
        }

        switch(filetype) {
            case "adf":
            case "idf":
                if (filename == null) //this is the case when we do download from google drive
                    holdfileString = JSON.stringify(data);//response.data from downloadAndOpenGoogleFile
                else //here we have a local file with adf extension
                    //read the content of the file and turn it into a string
                    holdfileString = fs.readFileSync(filename).toString();

                //remember that holdfileString is the string version of the json object ==> json string
                //and now we create a javascript call that contains the json string
                javascriptCmd = "loadActiveReport("+holdfileString+")";

                window.setTimeout(function() { //call later to make sure that the webview is appended to the document
                    aWebview.addEventListener("did-finish-load", function(){
                        //in here, we already loaded the jsonObjectLoaderPage
                        //aWebview.openDevTools();
                        //we now execute the javascript command using the command that we created previously
                        aWebview.executeJavaScript(javascriptCmd);
                    });

                    var path = require('path'); //open the path library and assign it to the variale called path
                    var url = require('url');

                    //load the jsonObjectLoaderPage.html
                    //set the url format on the browser url bar as: file://.../jsonObjectLoaderPage.html
                    aWebview.src = url.format({
                        //_dirname is the current directory
                        pathname: path.join(__dirname, 'jsonObjectLoaderPage.html'),
                        protocol: 'file:',
                        slashes: true
                    });

                },10);
                break;
            case "pdf":
                var path = require('path'); //open the path library and assign it to the variale called path
                var url = require('url');

                //set the url format on the browser url bar as: file://.../jsonObjectLoaderPage.html
                aWebview.src = url.format({
                    //_dirname is the current directory
                    pathname: filename,
                    protocol: 'file:',
                    slashes: true
                });
                break;
        }

        /*************
        if (holdfileString.substr(0,9)== '<!DOCTYPE') { //if we have an html page ==> create the iframe
            htmltxt = new Buffer(holdfileString).toString('base64'); //64 encoded
            htmltxt = "data:text/html;base64," + htmltxt;
            isHtmlPage = true;
        } else { //if Json object(hold.txt) ==> put it into the report One div
            //var iFrameContent = fs.readFileSync('iFrameContent.html').toString();
            //htmltxt must be a fully formed html doc for webview

            //remember that holdfileString is the string version of the json object ==> json string
            //and now we create a javascript call that contains the json string
            //javascriptCmd = "loadActiveReport("+holdfileString+")";

        //}
        **************/

    }//loadDocIntoTab()

    /***************************************************/
    /*Print ==> print preview to send a doc to the printer */
    /***************************************************/
    function printReport(){

        var mywebview =  document.getElementById("w_"+currentTabActive);
        mywebview.setAttribute('style','display:flex;height:3000px;width:3000px;');

        //get the webwiew window
        //var webviewWin = nw.Window.get(mywebview.contentWindow);
        //var executetxt = "window.alert(\"Opening for printing\");var win=window; win.print({'autoprint':false})";

        window.setTimeout(function() {
            mywebview.print();
        },100);
        //var executetxt = "var win=window; win.print({'autoprint':false})";
        //mywebview.executeJavaScript(executetxt);
    }

    /*********************************************/
    /***** Saving the content of the current tab.*/
    /*********************************************/
    function saveCurrentTab(filename,callback){

        var mywebview =  document.getElementById("w_"+currentTabActive);
        //get the webwiew window
        //var webviewWin = nw.Window.get(mywebview.contentWindow);
        var executetxt = "$AR.saveJsonReport()";
        mywebview.executeJavaScript(executetxt,false,
                 function(jsonObject){
                     var fs =  require('fs'); //load the node js file system library

                     //if the filename don't end with .adf, then append the 'adf' extension to it
                     var extension = filename.split('.');
                     var newfilename = filename;
                     if (extension[extension.length-1]!== 'adf')
                         newfilename += '.adf';

                     //write the content of the json object to a file
                     fs.writeFileSync(newfilename, JSON.stringify(jsonObject));
                     if(typeof(callback) != "undefined")
                             callback();
                 });
    }

    /***************************************/
    /***** Add a new tab into the tabList. */
    /***************************************/
    function addTabs(filename){
       // if (firstTime == true) return('report1');

        var tabList = document.getElementById("tabList");
        var listItem = document.createElement('li');
        var anch = document.createElement('a');
        tabItemCount++;
        var listItemId = "report" + (tabItemCount); //id has to be unique name, not upon tabItemCount

        //set ids for listItem and for anchor ==> need id when remove listItem from tabList
        listItem.setAttribute("id", "li_"+listItemId);
        anch.setAttribute("id", "a_"+listItemId);

        //set link for the listItem
        anch.href = "#" + listItemId;
        //set label of this tab
        var shortname = filename.split('\\');
        shortname = shortname[shortname.length-1];
        //anch.innerHTML = "report " + tabItemCount + "&nbsp;&nbsp;<span onclick='closeTabs("+tabItemCount+")' style='cursor:pointer;color: red'>X</span>";

        anch.innerHTML = '<input onclick="toggleCheckbox(event,this)" style="background-color:blue" type="checkbox"/>' + shortname + "&nbsp;&nbsp;<span onclick='closeTabs("+tabItemCount+")' style='cursor:pointer;color: red'>X</span>";
        anch.title = filename; //for hover over it
        listItem.appendChild(anch);
        tabList.appendChild(listItem);
        var liContent = document.createElement('div'); //create a div container to load the content of the list item
        liContent.id = listItemId;

        var tabsContainer = document.getElementById("tabsContainer");
        tabsContainer.appendChild(liContent);

        //refresh the tab list
        $("#tabsContainer").tabs("refresh");

        //make the new tab item active
        //$("#tabsContainer").tabs( "option", "active", tabItemCount-1 );
        $("#tabsContainer").tabs( "option", "active", tabList.children.length-1);
        $("#tabsContainer" ).on( "tabsactivate", function( event, ui ) {
            currentTabActive = ui.newPanel[0].id;
        } );

       // liContent.setAttribute('style', 'overflow:visible');
        return listItemId;
    }
    function toggleCheckbox(e,cb){
        e.stopPropagation();
        //cb.checked = !cb.checked;
    }

    /***************************************/
    /***** remove this tab from the tabList. */
    /***************************************/
    function closeTabs(tabId){

        var tabList = document.getElementById("tabList");
        var listItemId = "report" + tabId;
        var listItem = document.getElementById('li_'+listItemId);
        var anch = document.getElementById('a_'+listItemId);
        var div = document.getElementById(listItemId);
        listItem.parentNode.removeChild(listItem);
        anch.parentNode.removeChild(anch);
        div.parentNode.removeChild(div);
        //refresh the tab list
        $("#tabsContainer").tabs("refresh");

    }

//-->
    function showSplashScreen(){
        var win = gui.Window.open('app.html', {
            position: 'center',
            width: 901,
            height: 127,
            frame: true
        });
    }
    /****************************************************************************************/
    /* Save to Google Drive ==> Set up the credentials, save the authentication to a token,  */
    /* which allow users to have the write access to their google drive. If we are doing an upload */
    /* then we prompt the user for a filename for storing it into the Google Drive.*/
    /* Download from Google Drive ==> users can read files from their Google Drive */
    /********************************************************************/

    function signinToGoogle(dowhat, fileId, filename) {

        // Load client secrets from a local file.
        var fullFilename = app.getAppPath()+'\\'+'client_secret.json';

        if (fs.existsSync(fullFilename))
            console.log('Checking for: '+ fullFilename);

        fs.readFile(fullFilename, function processClientSecrets(err, content) {
            if (err) {
                console.log('Error loading client secret file: ' + err);
                return;
            }
            // Authorize a client with the loaded credentials, then call the
            // Drive API.
            if (dowhat == 'upload')
                authorize(JSON.parse(content), showUploadDialog);
            else if (dowhat == 'download')
                authorize(JSON.parse(content), downloadAndOpenGooglefile, fileId, filename);
            else if (dowhat == 'listfiles')
                authorize(JSON.parse(content), listFilesFromGoogle);
            else if (dowhat == 'gmail')
                authorize(JSON.parse(content), showGmailDialog);
        });
    }

    /*******************************************************************************************/
    /* Get user profile from Google and glpbally store it into googleInfo  */
    /*******************************************************************************************/
    var googleInfo = {};

    function getProfile(auth){
        const gmail = google.gmail({version: 'v1', auth});

        gmail.users.getProfile({
            auth: auth,
            userId: 'me'
        }, function(err, res) {
            if (err) {
                console.log(err);
            } else {
                console.log(res);
                googleInfo.emailAddress = res.data.emailAddress;
            }
        });

        var oauth2 = google.oauth2({
            auth: auth,
            version: 'v2'
        });

        oauth2.userinfo.v2.me.get(
                function(err, res) {
                    if (err) {
                        console.log(err);
                    } else {
                        googleInfo.fromName = res.data.name;
                        googleInfo.picture = res.data.picture;
                        console.log(res);
                    }
                });
    }


    /******************************************************************************
     * Create an OAuth2 client with the given credentials, and then execute the
     * given callback function.
     *
     * @param {Object} credentials The authorization client credentials.
     * @param {function} callback The callback to call with the authorized client.
     *****************************************************************************/
    function authorize(credentials, callback, fileId, filename) {
        var clientSecret = credentials.installed.client_secret;
        var clientId = credentials.installed.client_id;
        var redirectUrl = credentials.installed.redirect_uris[0];

        var oauth2Client = new googleAuth.OAuth2Client(clientId, clientSecret, redirectUrl);

        // Check if we have previously stored a token.
        fs.readFile(TOKEN_PATH, function(err, token) {
            if (err) {
                getNewToken(oauth2Client, callback);
            } else {
                oauth2Client.credentials = JSON.parse(token);
                getProfile(oauth2Client);
                callback(oauth2Client, fileId, filename);
            }
        });
    }

    /**
     * Get and store new token after prompting for user authorization, and then
     * execute the given callback with the authorized OAuth2 client.
     *
     * @param {google.auth.OAuth2} oauth2Client The OAuth2 client to get token for.
     * @param {getEventsCallback} callback The callback to call with the authorized
     *     client.
     */
    function getNewToken(oauth2Client, callback) {
        var authUrl = oauth2Client.generateAuthUrl({
            access_type: 'offline',
            scope: SCOPES
        });
        //let us access to the BrowserWindow object
        var BrowserWindow = require('electron').remote.BrowserWindow;

        // Or use `remote` from the renderer process.
        // const {BrowserWindow} = require('electron').remote

        var new_win = new BrowserWindow({width: 800, height: 600});
        new_win.webContents.on('dom-ready', function(e) {
            var token = e.sender.webContents.getTitle().split('=');
            if (token[0] == 'Success code') token = token[1];
            else token = null;

            if (token) {
                //alert(token.value);
                e.sender.destroy();
                oauth2Client.getToken(token, function (err, token) {
                    if (err) {
                        console.log('Error while trying to retrieve access token', err);
                        return;
                    }
                    oauth2Client.credentials = token;
                    storeToken(token);
                    getProfile(oauth2Client);
                    callback(oauth2Client);
                });
            };
        })

        // Load a remote URL
        new_win.loadURL(authUrl);
    }

    /**
     * Store token to disk be used in later program executions.
     *
     * @param {Object} token The token to store to disk.
     */
    function storeToken(token) {
        try {
            fs.mkdirSync(TOKEN_DIR);
        } catch (err) {
            if (err.code != 'EEXIST') {
                throw err;
            }
        }
        fs.writeFile(TOKEN_PATH, JSON.stringify(token));
        console.log('Token stored to ' + TOKEN_PATH);
    }


    /******************************************************/
    /* Show a dialog for entering the name  */
    /******************************************************/
    function listFilesFromGoogle(auth, fileId) {

        var drive = google.drive({ version: 'v3', auth: auth });

        drive.files.list({

        }, function(err, response) {
            if (err) {
                console.log('The API returned an error: ' + err);
                return;
            }
            var files = response.data.files;
            if (files.length == 0) {
                console.log('No files found.');
            } else {
                console.log('Files:');
                /***
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    console.log('%s (%s)', file.name, file.id);
                }***/
                displayDownloadDialog(auth, files);
            }
        }
        );
    }
    /******************************************************/
    /* Show a list of files from Google Drive for download */
    /******************************************************/
    function displayDownloadDialog(auth, files){

        var element = document.createElement('ol');
        var dl = document.getElementById('download-list');
        $("#download-list").empty();
        dl.appendChild(element);
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var li = document.createElement('li');
            li.innerHTML = "<span style='cursor:pointer' onclick='$(\"#dialog-listFiles\").dialog(\"close\");signinToGoogle(\"download\",\""+file.id+"\",\""+file.name+"\")'>"+file.name+"</span>";
            element.appendChild(li);
        }
        $( function() {
            $( "#dialog-listFiles" ).dialog({
                modal: true,
                buttons: {
                   Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        } );
    }

    /********************************************************/
    //using google drive api to get a file from google drive.
    //then open the file into a tab.
    /*********************************************************/
    function downloadAndOpenGooglefile(auth, fileId, filename){

        var drive = google.drive({ version: 'v3', auth: auth });
        drive.files.get({
            fileId: fileId,
            alt:'media',
            mimeType:'text/plain'
        }, function(err, response) {
            if (err) {
                console.log('The API returned an error: ' + err);
                return;
            }
            var myNextTabId = addTabs(filename);
            loadDocIntoTab(null, myNextTabId, response.data); //null is not a local file
        });
    }

    /******************************************/
    //display an upload dialog (jquery dialog)
    /******************************************/
    function showUploadDialog(auth){
        $( function() {
            $( "#dialog-message" ).dialog({
                modal: true,
                buttons: {
                    Ok: function() {
                        var chooser = document.querySelector("#googleFilename");
                        if (chooser.value!= "") {
                            $(this).dialog("close");
                            googleUpload(auth, chooser.value);
                        }
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        } );
    }

    /**********************************************/
    //Show an email dialog (jquery dialog)
    /**********************************************/
    function showEmailDialog(auth){
        $( function() {
            $( "#dialog-email" ).dialog({
                modal: true,
                buttons: {
                    Send: function() {
                        var emailFrom = document.querySelector("#emailFrom");
                        var emailTo = document.querySelector("#emailTo");
                        var ccTo = document.querySelector("#ccTo");
                        var emailSubject = document.querySelector("#emailSubject");
                        if (emailFrom.value != "" && emailTo.value != "") {
                            $(this).dialog("close");
                            emailFile(emailFrom.value, emailTo.value, ccTo.value, emailSubject.value);
                        }
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        } );
    }

    /********************************************************************/
    /* Email using smtp protocol (mailto) by talking to the smtp server */
    /* ==> currently can attach to the email but take a while to     */
    /* be received , need to close outlook and reopen it to see it */
    /********************************************************************/
    var tmpobj;

    function emailFile(emailFrom, emailTo, ccTo, emailSubject) {
        var tmp = require('tmp');
        tmpobj = tmp.fileSync({prefix: 'ar-', postfix: '.adf'});
        console.log('File: ', tmpobj.name);
        console.log('Filedescriptor: ', tmpobj.fd);
        saveCurrentTab(tmpobj.name, function(){emailFile2(emailFrom, emailTo, ccTo, emailSubject, tmpobj.name)});

        //return;
    }

    function emailFile2(emailFrom, emailTo, ccTo, emailSubject, filename){

        //process.env.TEMP;
        var email 	= require("emailjs");
        var server 	= email.server.connect({
            //user:    "patricia.cp.lam@gmail.com",
            //password:"",
            //host:    "ibismtp",
            host:    "ibismtp",
            //ssl:     true //for secure server
        });

    // send the message and get a callback with an error or details of the message that was sent
        server.send({
            text:    "i hope this works",
            //from:    "myself<patricia_lam@ibi.com>",
            //to:      "someone <patricia_lam@ibi.com>",
            from: emailFrom,
            to: emailTo,
            cc: ccTo,
            subject: emailSubject,
            //cc:      "else <else@your-email.com>",
            //subject: "testing emailjs",
            attachment:
                    [
                        {data:"<html>i <i>hope</i> this works!</html>", alternative:true},
                        {path:filename, type:"application/adf", name:"report.adf"}
                    ]
        }, function(err, message) {
            console.log(err || message);
            if (err)
                alert(err);
            else alert("mail sent successfully!")

            // If we don't need the file anymore we could manually call the removeCallback
            // But thanpt is not necessary if we didn't pass the keep option because the library
            // will clean after itself.
            tmpobj.removeCallback();
        });
    }

    /**********************************************/
    //Show a Gmail dialog (jquery dialog)
    /**********************************************/
    function showGmailDialog(auth, filename){
        $( function() {
            $( "#dialog-gmail" ).dialog({
                modal: true,
                buttons: {
                    Send: function() {
                        var gmailTo = document.querySelector("#gmailTo");
                        var gccTo = document.querySelector("#gccTo");
                        var gmailSubject = document.querySelector("#gmailSubject");
                        if (gmailTo.value != "") {
                            $(this).dialog("close");
                            sendMessage(auth, gmailTo.value, gccTo.value, gmailSubject.value);
                            //sendMessage(auth, gmailFrom.value, gmailTo.value, gmailSubject.value);
                        }
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        } );
    }
    /**************************************************************************************/
    function createBody(to, ccTo, subject, message, filename){

        var fs = require('fs');
        var dataBase64 = fs.readFileSync(filename);
        dataBase64 = dataBase64.toString('base64');

        var originalMail = {
            "from": googleInfo.emailAddress,
            "to": to,
            "cc": ccTo,
            "subject": subject,
            "fromName": googleInfo.fromName,
            "body": message,
            "cids": [],
            "attaches" : [{"base64":dataBase64,"name":"report.adf","type":"application/adf"}]
        };
        var mimeTxt = Mime.toMimeTxt(originalMail);
        var mimeObj = Mime.toMimeObj(mimeTxt);
        console.log(mimeTxt);
        console.log(mimeObj);
        var encodedMail = new Buffer(mimeTxt).toString("base64").replace(/\+/g, '-').replace(/\//g, '_');
        return encodedMail;
    }

/***************************
    function makeBody(to, from, subject, message) {
        var str = ["Content-Type: text/plain; charset=\"UTF-8\"\n",
            "MIME-Version: 1.0\n",
            "Content-Transfer-Encoding: 7bit\n",
            "to: ", to, "\n",
            "from: ", from, "\n",
            "subject: ", subject, "\n\n",
            message
        ].join('');

        var encodedMail = new Buffer(str).toString("base64").replace(/\+/g, '-').replace(/\//g, '_');
        return encodedMail;
    }
 ******************************/

    function sendMessage(auth, to, ccTo, subject) {
        var tmp = require('tmp');
        var tmpobj = tmp.fileSync({ prefix: 'ar-', postfix: '.adf' });
        console.log('File: ', tmpobj.name);
        console.log('Filedescriptor: ', tmpobj.fd);
        saveCurrentTab(tmpobj.name, function() {sendMessage2(auth, to, ccTo, subject,tmpobj.name)});
    }

    function sendMessage2(auth, to, ccTo, subject, filename) {

        const gmail = google.gmail({version: 'v1', auth});

        var raw = createBody(to, ccTo, subject, 'test gmail message', filename);
        gmail.users.messages.send({
            auth: auth,
            userId: 'me',
            resource: {
                raw: raw
            }
        }, function(err, response) {
            console.log(err || response)
        });
    }

    /**************************************************************************/
    //Get the webview and execute the saved json report command (by calling the Active api to save the output to json).
    //Then passing the json output to google drive api to save it.
    //Then call the google drive api to create a new file to google drive.
    /**************************************************************************/
    function googleUpload(auth, filename) {
        var mywebview =  document.getElementById("w_"+currentTabActive);

        var executetxt = "$AR.saveJsonReport()"; //return jsonObject

        mywebview.executeJavaScript(executetxt, false,
            function(jsonObject){
                var drive = google.drive({ version: 'v3', auth: auth });
                var fileMetadata = {
                    'name': filename,
                    'mimeType': 'application/vnd.ibi.idf'
                };
                // var holdfileString = fs.readFileSync('./hold.adf').toString();
                var media = {
                    mimeType: 'text/plain',
                    body: JSON.stringify(jsonObject)
                };
                drive.files.create({ //create the file in google drive
                    //resource: fileMetadata,
                    media: media
                    //fields: 'id' need data.id
                }, function (err, file) {
                    if (err) {
                        // Handle error
                        console.error(err);
                    } else {
                        console.log('File Id:', file.data.id);
                        drive.files.update({fileId:file.data.id,
                            resource:fileMetadata})
                    }
                });
            });
    }
</script>
</body>
</html>
